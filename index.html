<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JUST DO IT.</title>
  <style>
    /* ===== FONTS ===== */
    @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&family=M+PLUS+Rounded+1c:wght@700;800;900&display=swap');

    :root {
      --ink: #1a1a2e;
      --panel: rgba(255, 251, 232, 0.88);
      --panel2: rgba(255, 245, 240, 0.9);
      --red: #e63946;
      --orange: #ff7f11;
      --yellow: #ffd60a;
      --blue: #4361ee;
      --green: #06d6a0;
      --border: 3px solid var(--ink);
      --border-thick: 5px solid var(--ink);
      --shadow: 4px 4px 0px var(--ink);
      --shadow-lg: 6px 6px 0px var(--ink);
      --font-main: 'M PLUS Rounded 1c', 'Hiragino Maru Gothic Pro', sans-serif;
      --gauge-color: #06d6a0;
      --gauge-pct: 0%;
      --glow-color: rgba(6, 214, 160, 0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #ffd60a;
      background-image:
        radial-gradient(ellipse at 15% 10%, rgba(255,127,17,0.45) 0%, transparent 55%),
        radial-gradient(ellipse at 85% 90%, rgba(230,57,70,0.25) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(67,97,238,0.08) 0%, transparent 70%),
        radial-gradient(circle at 10px 10px, rgba(0,0,0,0.06) 1px, transparent 0),
        radial-gradient(circle at 30px 30px, rgba(0,0,0,0.03) 1px, transparent 0);
      background-size: auto, auto, auto, 40px 40px, 40px 40px;
      color: var(--ink);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* ===== EXPLOSION OVERLAY ===== */
    #explosion {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--red);
      background-image:
        repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(255,255,255,0.05) 20px, rgba(255,255,255,0.05) 40px);
      z-index: 100;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #explosion.active { display: flex; }

    /* çˆ†ç™ºèƒŒæ™¯ æ–œã‚ã‚¹ãƒ”ãƒ¼ãƒ‰ç·š */
    .speed-lines {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .speed-lines::before,
    .speed-lines::after {
      content: '';
      position: absolute;
      inset: -100%;
      background: repeating-conic-gradient(
        rgba(255,255,255,0.12) 0deg,
        transparent 1deg,
        transparent 8deg,
        rgba(255,255,255,0.08) 9deg,
        transparent 10deg
      );
      animation: spin-lines 4s linear infinite;
    }
    .speed-lines::after {
      animation-direction: reverse;
      animation-duration: 6s;
      opacity: 0.5;
    }
    @keyframes spin-lines {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ–‡å­— */
    .explosion-title {
      position: relative;
      z-index: 2;
      font-size: clamp(48px, 12vw, 120px);
      font-weight: 900;
      color: #fff;
      font-family: var(--font-main);
      text-align: center;
      line-height: 1;
      letter-spacing: 2px;
      /* ãƒãƒ³ã‚¬é¢¨ãƒ†ã‚­ã‚¹ãƒˆã‚·ãƒ£ãƒ‰ã‚¦ï¼ˆé»’ç¸å–ã‚Šï¼‰*/
      -webkit-text-stroke: 4px var(--ink);
      text-shadow:
        6px 6px 0px var(--ink),
        -2px -2px 0px var(--ink);
      animation: jdi-bounce 0.3s ease infinite alternate;
    }
    @keyframes jdi-bounce {
      from { transform: scale(1) rotate(-1deg); }
      to { transform: scale(1.04) rotate(1deg); }
    }

    /* shia canvas (çˆ†ç™ºæ™‚) */
    #shia-canvas-explosion {
      position: absolute;
      bottom: 0;
      right: 0;
      width: min(50vw, 400px);
      height: min(75vh, 600px);
      z-index: 1;
      pointer-events: none;
    }

    /* çˆ†ç™ºæ™‚ã®å¹ãå‡ºã— */
    .explosion-speech {
      position: relative;
      z-index: 3;
      background: #fff;
      border: var(--border-thick);
      border-radius: 20px;
      padding: 14px 24px;
      margin: 16px 24px;
      font-size: clamp(14px, 3.5vw, 22px);
      font-weight: 900;
      color: var(--ink);
      max-width: 500px;
      text-align: center;
      box-shadow: var(--shadow-lg);
      /* å¹ãå‡ºã—ä¸‰è§’ */
      position: relative;
    }
    .explosion-speech::before {
      content: '';
      position: absolute;
      bottom: -22px;
      left: 50%;
      transform: translateX(-50%);
      border: 11px solid transparent;
      border-top: 11px solid var(--ink);
    }
    .explosion-speech::after {
      content: '';
      position: absolute;
      bottom: -16px;
      left: 50%;
      transform: translateX(-50%);
      border: 9px solid transparent;
      border-top: 9px solid #fff;
    }

    #dismiss-btn {
      position: relative;
      z-index: 3;
      margin-top: 32px;
      padding: 14px 40px;
      background: linear-gradient(135deg, var(--yellow) 0%, #ffb703 100%);
      border: var(--border-thick);
      color: var(--ink);
      font-size: 18px;
      font-weight: 900;
      font-family: var(--font-main);
      border-radius: 14px;
      cursor: pointer;
      box-shadow: var(--shadow-lg), 0 0 20px rgba(255,214,10,0.6);
      transition: transform 0.1s, box-shadow 0.1s;
      letter-spacing: 1px;
      touch-action: manipulation;
    }
    #dismiss-btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0px var(--ink), 0 0 10px rgba(255,214,10,0.4);
    }
    #dismiss-btn:active {
      transform: translate(4px, 4px);
      box-shadow: none;
    }

    #sparks-canvas {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 4;
    }

    /* ===== MAIN WRAPPER ===== */
    .wrapper {
      width: 100%;
      max-width: 680px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }

    /* ===== HEADER ===== */
    .header {
      text-align: center;
      padding: 8px 0 4px;
      position: relative;
    }
    .header h1 {
      font-size: clamp(32px, 10vw, 64px);
      font-weight: 900;
      color: var(--ink);
      font-family: var(--font-main);
      -webkit-text-stroke: 2px var(--ink);
      text-shadow:
        4px 4px 0 var(--red),
        8px 8px 0 rgba(230,57,70,0.3),
        -1px -1px 0 var(--ink),
        1px -1px 0 var(--ink),
        -1px 1px 0 var(--ink);
      letter-spacing: 5px;
      line-height: 1;
      animation: title-wiggle 2s ease infinite;
    }
    @keyframes title-wiggle {
      0%,100% { transform: rotate(-0.5deg) scale(1); }
      50% { transform: rotate(0.5deg) scale(1.01); }
    }
    .header .subtitle {
      font-size: 12px;
      color: var(--ink);
      margin-top: 8px;
      font-weight: 800;
      background: var(--ink);
      color: var(--yellow);
      display: inline-block;
      padding: 3px 16px;
      border: 2px solid var(--ink);
      border-radius: 99px;
      letter-spacing: 2px;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
    }

    /* ===== GAUGE POPUP ===== */
    .gauge-popup {
      position: fixed;
      left: 50%;
      bottom: 120px;
      transform: translateX(-50%) translateY(0);
      pointer-events: none;
      z-index: 200;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      animation: popup-rise 1.8s ease forwards;
    }
    .gauge-popup .popup-pct {
      font-size: clamp(32px, 7vw, 56px);
      font-weight: 900;
      font-family: var(--font-main);
      -webkit-text-stroke: 3px var(--ink);
      text-shadow: 4px 4px 0 var(--ink);
      white-space: nowrap;
      color: #fff;
    }
    .gauge-popup.excuse .popup-pct { color: var(--red); }
    .gauge-popup.action  .popup-pct { color: var(--green); }

    .gauge-popup .popup-phrase {
      background: var(--ink);
      color: var(--yellow);
      font-size: clamp(11px, 2.5vw, 16px);
      font-weight: 900;
      letter-spacing: 2px;
      padding: 3px 14px;
      border-radius: 4px;
      white-space: nowrap;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
    }

    @keyframes popup-rise {
      0%   { opacity: 0;   transform: translateX(-50%) translateY(20px) scale(0.5); }
      12%  { opacity: 1;   transform: translateX(-50%) translateY(0px)  scale(1.2); }
      25%  { opacity: 1;   transform: translateX(-50%) translateY(0px)  scale(1); }
      70%  { opacity: 1;   transform: translateX(-50%) translateY(-15px) scale(1); }
      100% { opacity: 0;   transform: translateX(-50%) translateY(-50px) scale(0.8); }
    }

    /* ===== SHIA POPUP (Unity game-style bounce popup) ===== */
    #shia-popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 190;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      transform: scale(0);
      transform-origin: bottom right;
      opacity: 0;
    }
    #shia-popup.shia-show {
      animation: shiaPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    #shia-popup.shia-visible {
      transform: scale(1);
      opacity: 1;
    }
    #shia-popup.shia-hide {
      animation: shiaPopOut 0.28s cubic-bezier(0.4, 0, 1, 1) forwards;
    }
    @keyframes shiaPopIn {
      0%   { transform: scale(0) rotate(-10deg); opacity: 0; }
      55%  { transform: scale(1.14) rotate(3deg); opacity: 1; }
      75%  { transform: scale(0.95) rotate(-1deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes shiaPopOut {
      0%   { transform: scale(1) rotate(0deg); opacity: 1; }
      40%  { transform: scale(1.06) rotate(-2deg); opacity: 1; }
      100% { transform: scale(0) rotate(8deg); opacity: 0; }
    }

    /* Speech bubble above character */
    .shia-popup-speech {
      background: #fff;
      border: 4px solid var(--ink);
      border-radius: 14px;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 900;
      color: var(--ink);
      max-width: 180px;
      text-align: center;
      box-shadow: 3px 3px 0 var(--ink);
      position: relative;
      font-family: var(--font-main);
      animation: speech-float 1.8s ease-in-out infinite;
      white-space: nowrap;
    }
    .shia-popup-speech::after {
      content: '';
      position: absolute;
      bottom: -14px;
      right: 20px;
      border: 7px solid transparent;
      border-top: 7px solid var(--ink);
    }
    .shia-popup-speech::before {
      content: '';
      position: absolute;
      bottom: -9px;
      right: 21px;
      border: 6px solid transparent;
      border-top: 6px solid #fff;
      z-index: 1;
    }
    @keyframes speech-float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    /* Canvas wrapper â€” ãƒœãƒ¼ãƒ€ãƒ¼ãªã—ï¼ˆä¸€ä½“æ„Ÿã‚’ä¿ã¤ï¼‰ */
    .shia-canvas-wrapper {
      position: relative;
      width: min(32vw, 220px);
      height: min(48vw, 330px);
      overflow: hidden;
      border-radius: 14px;
      background: transparent;
    }

    /* Static emoji face (fallback when video unavailable) */
    .shia-static-face {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      background: linear-gradient(160deg, #fff8f0 0%, #fffbe8 100%);
      animation: face-idle 1.2s ease-in-out infinite alternate;
    }
    @keyframes face-idle {
      from { transform: scale(1) rotate(-1deg); }
      to   { transform: scale(1.06) rotate(1deg); }
    }

    #shia-canvas-comment {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
    }

    /* ===== GAUGE SECTION ===== */
    .gauge-section {
      background: var(--panel);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: var(--border-thick);
      border-radius: 20px;
      padding: 18px 22px;
      box-shadow: var(--shadow), 0 8px 32px rgba(255, 214, 10, 0.35);
    }
    .gauge-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .gauge-label .label-text {
      font-size: 14px;
      font-weight: 900;
      color: var(--ink);
      letter-spacing: 1px;
    }
    .gauge-label .pct {
      font-size: 18px;
      font-weight: 900;
      color: var(--gauge-color);
      -webkit-text-stroke: 1px var(--ink);
      font-family: var(--font-main);
      min-width: 52px;
      text-align: right;
    }

    .gauge-bar {
      width: 100%;
      height: 22px;
      background: #fff;
      border-radius: 99px;
      overflow: hidden;
      border: 3px solid var(--ink);
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.1);
    }
    .gauge-fill {
      height: 100%;
      width: var(--gauge-pct);
      min-width: 0;
      background: linear-gradient(90deg, var(--gauge-color) 0%, var(--yellow) 80%, #fff 100%);
      border-radius: 99px;
      transition: width 0.4s cubic-bezier(.4,2,.6,1), background 0.3s, box-shadow 0.3s;
      box-shadow: 0 0 14px var(--gauge-color), 0 0 5px rgba(255,255,255,0.4) inset;
    }

    .gauge-stages {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }
    .gauge-stages span {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
      opacity: 0.6;
    }

    /* ===== CHAT BOX ===== */
    .chat-box {
      background: var(--panel);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: var(--border-thick);
      border-radius: 20px;
      height: 340px;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      scroll-behavior: smooth;
      box-shadow: var(--shadow), 0 4px 20px rgba(0,0,0,0.08);
    }
    .chat-box::-webkit-scrollbar { width: 6px; }
    .chat-box::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 99px; }
    .chat-box::-webkit-scrollbar-thumb { background: var(--ink); border-radius: 99px; }

    .msg {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      animation: msg-in 0.2s ease;
    }
    .msg.user { flex-direction: row-reverse; }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      border: 3px solid var(--ink);
      box-shadow: 2px 2px 0 var(--ink);
    }
    .msg.oji .avatar {
      background: radial-gradient(circle at 50% 30%, #ff8c00, #c0392b);
      font-size: 22px;
    }
    .msg.user .avatar {
      background: var(--blue);
      color: #fff;
      font-size: 18px;
    }

    /* ãƒãƒ³ã‚¬å¹ãå‡ºã— */
    .bubble {
      max-width: 78%;
      padding: 10px 16px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 700;
      line-height: 1.6;
      font-family: var(--font-main);
      position: relative;
      border: 3px solid var(--ink);
      box-shadow: 3px 3px 0 var(--ink);
    }
    /* ojiå¹ãå‡ºã—ï¼ˆå·¦å‘ãï¼‰*/
    .msg.oji .bubble {
      background: #fff;
      color: var(--ink);
      border-bottom-left-radius: 4px;
    }
    .msg.oji .bubble::before {
      content: '';
      position: absolute;
      left: -14px;
      bottom: 10px;
      border: 7px solid transparent;
      border-right: 7px solid var(--ink);
    }
    .msg.oji .bubble::after {
      content: '';
      position: absolute;
      left: -9px;
      bottom: 11px;
      border: 5px solid transparent;
      border-right: 5px solid #fff;
    }

    /* warningå¹ãå‡ºã— */
    .msg.oji .bubble.warning {
      background: var(--panel2);
      border-color: var(--red);
      box-shadow: 3px 3px 0 var(--red);
      color: var(--red);
    }
    .msg.oji .bubble.warning::before { border-right-color: var(--red); }
    .msg.oji .bubble.warning::after  { border-right-color: var(--panel2); }

    /* userå¹ãå‡ºã—ï¼ˆå³å‘ãï¼‰*/
    .msg.user .bubble {
      background: linear-gradient(135deg, var(--blue) 0%, #2748d4 100%);
      color: #fff;
      border-color: var(--ink);
      border-bottom-right-radius: 4px;
      box-shadow: 3px 3px 0 var(--ink), 0 0 12px rgba(67,97,238,0.3);
    }
    .msg.user .bubble::before {
      content: '';
      position: absolute;
      right: -14px;
      bottom: 10px;
      border: 7px solid transparent;
      border-left: 7px solid var(--ink);
    }
    .msg.user .bubble::after {
      content: '';
      position: absolute;
      right: -9px;
      bottom: 11px;
      border: 5px solid transparent;
      border-left: 5px solid var(--blue);
    }

    /* ===== THINKING ===== */
    .thinking-dots span {
      display: inline-block;
      animation: dot-bounce 1s infinite;
      font-size: 22px;
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot-bounce {
      0%,80%,100% { transform: translateY(0); }
      40% { transform: translateY(-8px); }
    }

    /* ===== INPUT AREA ===== */
    .input-area {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    .textarea-wrap {
      flex: 1;
      position: relative;
    }
    .char-count {
      position: absolute;
      bottom: 6px;
      right: 10px;
      font-size: 10px;
      font-weight: 700;
      color: rgba(26,26,46,0.3);
      pointer-events: none;
      font-family: var(--font-main);
      transition: color 0.2s;
    }
    .char-count.warn { color: var(--orange); }
    .char-count.danger { color: var(--red); }
    .input-area textarea {
      width: 100%;
      background: rgba(255,255,255,0.95);
      border: var(--border-thick);
      border-radius: 14px;
      color: var(--ink);
      font-size: 16px; /* 16px prevents iOS auto-zoom on focus */
      font-weight: 700;
      font-family: var(--font-main);
      padding: 12px 14px;
      resize: none;
      outline: none;
      line-height: 1.5;
      height: 58px;
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s, transform 0.2s;
      touch-action: manipulation;
    }
    .input-area textarea:focus {
      box-shadow: 5px 5px 0 var(--ink), 0 0 0 3px rgba(67,97,238,0.2);
      transform: translate(-1px, -1px);
    }
    .input-area textarea::placeholder {
      color: rgba(26,26,46,0.38);
      font-weight: 700;
    }

    .send-btn {
      width: 58px;
      height: 58px;
      background: linear-gradient(135deg, var(--red) 0%, #c0392b 100%);
      border: var(--border-thick);
      border-radius: 14px;
      color: #fff;
      font-size: 24px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: var(--shadow), 0 0 12px rgba(230,57,70,0.4);
      transition: transform 0.12s, box-shadow 0.12s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }
    .send-btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: var(--shadow-lg), 0 0 18px rgba(230,57,70,0.5);
    }
    .send-btn:active {
      transform: translate(3px, 3px);
      box-shadow: none;
    }
    .send-btn:disabled {
      background: #aaa;
      cursor: not-allowed;
      transform: none;
      box-shadow: 2px 2px 0 var(--ink);
    }

    /* ===== HINT ===== */
    .hint {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
      text-align: center;
      opacity: 0.5;
      letter-spacing: 0.5px;
    }

    /* ===== WRAPPER ENTRANCE ===== */
    .wrapper {
      animation: wrapper-in 0.6s cubic-bezier(0.34, 1.4, 0.64, 1) both;
    }
    @keyframes wrapper-in {
      from { opacity: 0; transform: translateY(24px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* ===== ANIMATIONS ===== */
    @keyframes shake {
      0%,100% { transform: translateX(0) rotate(0deg); }
      20% { transform: translateX(-8px) rotate(-3deg); }
      40% { transform: translateX(8px) rotate(3deg); }
      60% { transform: translateX(-5px) rotate(-2deg); }
      80% { transform: translateX(5px) rotate(2deg); }
    }
    @keyframes msg-in {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes gauge-flash {
      0%,100% { filter: none; box-shadow: 0 0 14px var(--gauge-color); }
      50% { filter: brightness(1.4) saturate(1.6); box-shadow: 0 0 28px var(--gauge-color), 0 0 10px #fff; }
    }

    /* ===== ã‚¯ã‚©ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« ===== */
    .msg.oji .bubble.quota {
      background: #fffbe8;
      border-color: var(--orange);
      box-shadow: 3px 3px 0 var(--orange);
      color: var(--ink);
    }
    .msg.oji .bubble.quota::before { border-right-color: var(--orange); }
    .msg.oji .bubble.quota::after  { border-right-color: #fffbe8; }

    /* ===== CREDIT ===== */
    .credit {
      font-size: 10px;
      color: var(--ink);
      text-align: center;
      opacity: 0.4;
      font-weight: 700;
      padding-bottom: 4px;
    }
  </style>
</head>
<body>

<!-- ===== EXPLOSION OVERLAY ===== -->
<div id="explosion">
  <div class="speed-lines"></div>
  <canvas id="sparks-canvas"></canvas>
  <canvas id="shia-canvas-explosion"></canvas>
  <div class="explosion-title" id="jdi-text">JUST<br>DO IT!!</div>
  <div class="explosion-speech" id="oji-speech"></div>
  <button id="dismiss-btn" onclick="dismissExplosion()">â€¦ã‚ã‹ã£ãŸã€ã‚„ã‚‹</button>
</div>

<!-- shia popup (Unity game-style bounce popup) -->
<div id="shia-popup">
  <div class="shia-popup-speech" id="shia-popup-speech">ã‚„ã‚Œï¼</div>
  <div class="shia-canvas-wrapper">
    <div class="shia-static-face" id="shia-static-face">ğŸ˜¤</div>
    <canvas id="shia-canvas-comment"></canvas>
  </div>
</div>

<!-- ===== MAIN ===== -->
<div class="wrapper">
  <div class="header">
    <h1>JUST DO IT.</h1>
    <p class="subtitle">è¨€ã„è¨³ã—ãŸã‚‰æ€’ã‚‰ã‚Œã‚‹ã‚„ã¤</p>
  </div>

  <div class="gauge-section">
    <div class="gauge-label">
      <span class="label-text">âš¡ è¨€ã„è¨³ã‚²ãƒ¼ã‚¸</span>
      <span class="pct" id="gauge-pct">0%</span>
    </div>
    <div class="gauge-bar">
      <div class="gauge-fill" id="gauge-fill"></div>
    </div>
    <div class="gauge-stages">
      <span>ğŸ˜Œ ä½™è£•</span>
      <span>ğŸ˜ æ€ªã—ã„</span>
      <span>ğŸ˜¤ å±é™º</span>
      <span>ğŸ’¥ é™ç•Œ</span>
    </div>
  </div>

  <div class="chat-box" id="chat-box"></div>

  <div class="input-area">
    <div class="textarea-wrap">
      <textarea id="user-input" placeholder="ã§ã€ä»Šæ—¥ã¯ä½•ã‚„ã‚‹ã‚“ã ï¼Ÿ" rows="2" maxlength="500"></textarea>
      <span class="char-count" id="char-count">0/400</span>
    </div>
    <button class="send-btn" id="send-btn" onclick="handleSend()">â–²</button>
  </div>

  <p class="hint">Enter ã§é€ä¿¡ ï¼ Shift+Enter ã§æ”¹è¡Œ</p>
  <p class="credit">Inspired by Shia LaBeouf "Just Do It" (2015) â€” Non-commercial fan project</p>
</div>

<script>
// ===== CONFIG =====
const GAUGE_MAX = 100;
const EXPLOSION_THRESHOLD = 100;

// ===== STATE =====
let gaugeValue = 0;
let conversationHistory = [];

// ===== GEMINI API =====
const SYSTEM_PROMPT = `You are the "JUST DO IT guy" â€” modeled after Shia LaBeouf's famous motivational speech.

Your personality and speech style:
- Intense, passionate, direct. You believe ANYONE can achieve anything if they just DO IT.
- You speak with conviction and urgency. Short punchy sentences. Lots of emphasis.
- Key phrases you use naturally: "JUST DO IT!", "Don't let your dreams be dreams!", "Yesterday you said tomorrow.", "Make your dreams come true!", "Nothing is impossible!", "If you're tired of starting over, stop giving up!"
- When the user makes excuses, you listen... but your patience wears thin. You push back harder as the gauge rises.
- You are NOT mean or cruel â€” you genuinely believe in the user. But you are frustrated by excuses.
- You speak in Japanese to the user (since they write in Japanese), but your energy is Shia LaBeouf.

Gauge stages (current gauge will be provided with each message):
- 0-30%: Warm, encouraging. "I believe in you! Just take the first step!"
- 30-60%: Getting impatient. "Yesterday you said tomorrow... sound familiar?"
- 60-80%: Almost at limit. "HOW BAD DO YOU WANT IT?! Stop making excuses!"
- 70%+ with excuse: DESPERATE. "Please... I'm begging you... JUST DO IT!!"
- On ACTION declaration: Pure joy and celebration. "YES!! THAT'S IT!! GO GO GO!!"

IMPORTANT: Respond to the actual content of what the user says. Reference their specific situation. Make it feel personal, not generic.

Always respond in Japanese. Reply must be natural Japanese while capturing Shia's passionate energy.

å¿…ãšJSONã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„ï¼ˆä»–ã®ãƒ†ã‚­ã‚¹ãƒˆä¸å¯ï¼‰ï¼š
{
  "type": "EXCUSE" | "ACTION" | "NEUTRAL",
  "score": 0-50,
  "reply": "è¿”ç­”ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ—¥æœ¬èªï¼‰"
}

typeã®å®šç¾©ï¼š
- EXCUSE: è¨€ã„è¨³ã€å¾Œã‚å‘ãã€ãƒã‚¤ãƒŠã‚¹ç™ºè¨€ã€ã‚„ã‚‰ãªã„ç†ç”±ã€ãƒã‚¬ãƒ†ã‚£ãƒ–ãªæ„Ÿæƒ…è¡¨ç¾ã€ç–²ã‚ŒãŸãƒ»ã§ããªã„ãƒ»ã‚ã‚“ã©ã„ç­‰
- ACTION: è¡Œå‹•å®£è¨€ã€ã‚„ã‚‹ã¨æ±ºã‚ãŸç™ºè¨€ã€å®Ÿè¡Œãƒ»å®Œäº†å ±å‘Š
- NEUTRAL: ã©ã¡ã‚‰ã§ã‚‚ãªã„æ™®é€šã®ç™ºè¨€

scoreã¯å¿…ãšæ­£ã®æ•´æ•°ï¼ˆ0-50ï¼‰ã€‚EXCUSEãªã‚‰å¢—åŠ é‡ã€ACTIONãªã‚‰æ¸›å°‘é‡ã€NEUTRALãªã‚‰0ã€‚è² ã®å€¤ã¯è¿”ã•ãªã„ã“ã¨ã€‚
replyã¯1ã€œ3æ–‡ã€‚ã‚²ãƒ¼ã‚¸å€¤ã¨ä¼šè©±ã®æ–‡è„ˆã‚’è¸ã¾ãˆãŸè¿”ç­”ã€‚`;

// ===== ã‚¯ã‚©ãƒ¼ã‚¿/ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ™‚ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™ºè¨€ =====
const QUOTA_MESSAGES = [
  'â€¦ä»Šã¯å°‘ã—å¾…ã¦ã€‚ä¿ºã«ã‚‚é™ç•Œã¯ã‚ã‚‹ã€‚ã ãŒãŠå‰ã¸ã®æœŸå¾…ã¯ã€æ°¸é ã«é™ç•Œã‚’çŸ¥ã‚‰ãªã„ã€‚',
  'ä¼‘æ†©ã ã€‚ä¿ºãŒä¼‘ã‚€é–“ã«ã€ãŠå‰ã¯æ¬¡ã«ä½•ã‚’ã‚„ã‚‹ã‹è€ƒãˆã¦ãŠã‘ã€‚',
  'â€¦å°‘ã—é–“ã‚’ç½®ã“ã†ã€‚æ¬¡ã«è©±ã™æ™‚ã€è¨€ã„è¨³ã¯ãªã—ã ã€‚ã„ã„ãªï¼Ÿ',
  'ä»Šã¯ä¿ºã®å£°ãŒå±Šã‹ãªã„ã€‚ã ãŒãã®é–“ã‚‚ã€æ™‚é–“ã¯å‹•ã„ã¦ã„ã‚‹ã€‚ç„¡é§„ã«ã™ã‚‹ãªã€‚',
  'â€¦é™ã‹ã«ã—ã¦ã‚ã€‚ä¿ºãŒæˆ»ã£ã¦ããŸã‚‰ã€ãŠå‰ã®ã€Œã‚„ã£ãŸã€ã¨ã„ã†å ±å‘Šã ã‘èãã€‚',
];

// ===== GAUGE =====
function getGaugeStage() {
  if (gaugeValue < 30) return 0;
  if (gaugeValue < 60) return 1;
  if (gaugeValue < 80) return 2;
  return 3;
}

function updateGauge(value) {
  gaugeValue = Math.min(Math.max(value, 0), GAUGE_MAX);
  const pct = Math.round(gaugeValue);

  document.documentElement.style.setProperty('--gauge-pct', pct + '%');
  document.getElementById('gauge-pct').textContent = pct + '%';

  let color;
  if (pct < 40)      color = '#06d6a0';
  else if (pct < 70) color = '#ffd60a';
  else if (pct < 90) color = '#ff7f11';
  else               color = '#e63946';

  document.documentElement.style.setProperty('--gauge-color', color);

  const fill = document.getElementById('gauge-fill');
  if (pct >= 70) {
    fill.style.animation = 'gauge-flash 0.5s infinite';
  } else {
    fill.style.animation = 'none';
  }
}

// ===== CHAT UI =====
function addMessage(role, text, styleClass = '') {
  const box = document.getElementById('chat-box');
  const div = document.createElement('div');
  div.className = `msg ${role}`;

  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = role === 'oji' ? 'ğŸ§”â€â™‚ï¸' : 'ğŸ™‹';

  const bubble = document.createElement('div');
  bubble.className = 'bubble' + (styleClass ? ' ' + styleClass : '');

  if (role === 'oji') {
    bubble.textContent = '';
    div.appendChild(avatar);
    div.appendChild(bubble);
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;

    let i = 0;
    const speed = Math.max(15, Math.min(40, 1200 / text.length));
    const timer = setInterval(() => {
      bubble.textContent += text[i];
      i++;
      box.scrollTop = box.scrollHeight;
      if (i >= text.length) clearInterval(timer);
    }, speed);
  } else {
    bubble.textContent = text;
    div.appendChild(avatar);
    div.appendChild(bubble);
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
}

function addThinking() {
  const box = document.getElementById('chat-box');
  const div = document.createElement('div');
  div.className = 'msg oji';
  div.id = 'thinking-msg';

  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = 'ğŸ§”â€â™‚ï¸';

  const bubble = document.createElement('div');
  bubble.className = 'bubble thinking-dots';
  bubble.innerHTML = '<span>â—</span><span>â—</span><span>â—</span>';

  div.appendChild(avatar);
  div.appendChild(bubble);
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function removeThinking() {
  const el = document.getElementById('thinking-msg');
  if (el) el.remove();
}

// ===== CHROMA KEY CANVAS =====
// ã‚°ãƒªãƒ¼ãƒ³é™¤å»ã—ã¦canvasã«æç”»ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã‚¹ãƒ”ãƒ«æŠ‘åˆ¶ä»˜ãï¼‰
function drawChromaKey(videoEl, canvasEl, threshold = 45) {
  if (!videoEl || videoEl.readyState < 2) return;

  const w = canvasEl.width;
  const h = canvasEl.height;
  const ctx = canvasEl.getContext('2d');

  // ä¸€æ™‚canvasã§ãƒ”ã‚¯ã‚»ãƒ«æ“ä½œ
  const tmpCanvas = document.createElement('canvas');
  tmpCanvas.width = w;
  tmpCanvas.height = h;
  const tmpCtx = tmpCanvas.getContext('2d');

  tmpCtx.drawImage(videoEl, 0, 0, w, h);
  const imageData = tmpCtx.getImageData(0, 0, w, h);
  const data = imageData.data;

  for (let i = 0; i < data.length; i += 4) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];
    // ã‚°ãƒªãƒ¼ãƒ³è¶…éé‡: GãŒä»–ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚ˆã‚Šçªå‡ºã—ã¦ã„ã‚‹åº¦åˆã„
    const greenExcess = g - Math.max(r, b);
    if (greenExcess > threshold) {
      // æ˜ã‚‰ã‹ã«ã‚°ãƒªãƒ¼ãƒ³ â†’ å®Œå…¨é€æ˜åŒ–
      data[i + 3] = 0;
    } else if (greenExcess > threshold * 0.4) {
      // ã‚¨ãƒƒã‚¸éƒ¨åˆ† â†’ ã‚½ãƒ•ãƒˆé€æ˜åŒ–ï¼ˆã‚¹ãƒ”ãƒ«æŠ‘åˆ¶ï¼‰
      const ratio = (greenExcess - threshold * 0.4) / (threshold * 0.6);
      data[i + 3] = Math.round(data[i + 3] * (1 - ratio));
    }
  }
  ctx.clearRect(0, 0, w, h);
  ctx.putImageData(imageData, 0, 0);
}

// ===== SHIA COMMENT VIDEO (ãƒãƒ©è¦‹ã›) =====
let commentVideo = null;
let commentAnimFrame = null;
let commentHideTimer = null;

function initCommentVideo() {
  commentVideo = document.createElement('video');
  commentVideo.src = 'shia_comment.mp4';
  commentVideo.preload = 'auto';
  commentVideo.muted = false; // éŸ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œãªã‚‰å†ç”Ÿå¯èƒ½ï¼‰
  commentVideo.playsInline = true;
  commentVideo.loop = false;
  commentVideo.crossOrigin = 'anonymous';
}

// ã‚·ãƒ£ã‚¤ã‚¢ã®å°è©ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ™‚ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼‰
const SHIA_SPEECHES = [
  'ã‚„ã‚Œï¼', 'JUST DO IT!', 'ã‚„ã‚‹æ°—ã ã›ï¼',
  'ä»Šã™ãã ï¼', 'è¨€ã„è¨³ã™ãªï¼', 'DO IT!!', 'å‹•ã‘ï¼',
];

// ã‚²ãƒ¼ã‚¸æ®µéšåˆ¥ã®è¡¨æƒ…çµµæ–‡å­—
const SHIA_FACES = {
  0: ['ğŸ˜Š', 'ğŸ™‚', 'ğŸ˜Œ'],    // ä½™è£•
  1: ['ğŸ˜¤', 'ğŸ˜‘', 'ğŸ˜¶'],    // æ€ªã—ã„
  2: ['ğŸ˜ ', 'ğŸ˜¡', 'ğŸ”¥'],    // å±é™º
  3: ['ğŸ¤¬', 'ğŸ’¢', 'ğŸ˜¤'],    // é™ç•Œ
};

function getShiaFace() {
  const stage = getGaugeStage();
  const faces = SHIA_FACES[stage];
  return faces[Math.floor(Math.random() * faces.length)];
}

function showCommentVideo() {
  const popup = document.getElementById('shia-popup');
  const canvas = document.getElementById('shia-canvas-comment');
  const staticFace = document.getElementById('shia-static-face');
  const speechEl = document.getElementById('shia-popup-speech');

  // å‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
  if (commentAnimFrame) cancelAnimationFrame(commentAnimFrame);
  if (commentHideTimer) clearTimeout(commentHideTimer);

  // å¹ãå‡ºã—ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ è¨­å®š
  speechEl.textContent = SHIA_SPEECHES[Math.floor(Math.random() * SHIA_SPEECHES.length)];

  // é™æ­¢çµµæ–‡å­—ã‚’è¨­å®šï¼ˆã‚²ãƒ¼ã‚¸æ®µéšã«åˆã‚ã›ã¦ï¼‰
  staticFace.textContent = getShiaFace();
  staticFace.style.display = 'flex';

  // canvasã‚µã‚¤ã‚ºã‚’wrapperã«åˆã‚ã›ã‚‹
  const wrapper = popup.querySelector('.shia-canvas-wrapper');
  canvas.width = wrapper.offsetWidth || 220;
  canvas.height = wrapper.offsetHeight || 330;
  canvas.style.opacity = '0';

  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
  popup.classList.remove('shia-hide', 'shia-visible');
  void popup.offsetWidth; // reflow
  popup.classList.add('shia-show');
  popup.addEventListener('animationend', () => {
    popup.classList.remove('shia-show');
    popup.classList.add('shia-visible');
  }, { once: true });

  // å‹•ç”»å†ç”Ÿã‚’è©¦ã¿ã‚‹ï¼ˆéŸ³ã‚ã‚Š â†’ å¤±æ•—æ™‚ã¯ãƒŸãƒ¥ãƒ¼ãƒˆã§å†è©¦è¡Œï¼‰
  if (commentVideo) {
    commentVideo.currentTime = 0;

    function startRenderLoop() {
      function renderFrame() {
        if (!commentVideo || commentVideo.ended || commentVideo.paused) return;
        drawChromaKey(commentVideo, canvas, 45);
        if (canvas.style.opacity === '0') {
          canvas.style.opacity = '1';
          staticFace.style.display = 'none';
        }
        commentAnimFrame = requestAnimationFrame(renderFrame);
      }
      commentAnimFrame = requestAnimationFrame(renderFrame);
    }

    commentVideo.play()
      .then(startRenderLoop)
      .catch(() => {
        // éŸ³ã‚ã‚ŠãŒå¤±æ•— â†’ ãƒŸãƒ¥ãƒ¼ãƒˆã§å†è©¦è¡Œï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼å¯¾å¿œï¼‰
        commentVideo.muted = true;
        commentVideo.play()
          .then(startRenderLoop)
          .catch(() => {
            // å®Œå…¨ã«å¤±æ•— â†’ é™æ­¢çµµæ–‡å­—ã®ã¾ã¾è¡¨ç¤º
            canvas.style.opacity = '0';
          });
      });
  }

  // 6ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤º
  commentHideTimer = setTimeout(hideCommentVideo, 6000);
}

function hideCommentVideo() {
  const popup = document.getElementById('shia-popup');
  const canvas = document.getElementById('shia-canvas-comment');

  if (commentAnimFrame) {
    cancelAnimationFrame(commentAnimFrame);
    commentAnimFrame = null;
  }
  if (commentHideTimer) {
    clearTimeout(commentHideTimer);
    commentHideTimer = null;
  }
  if (commentVideo) {
    commentVideo.pause();
  }

  // ãƒãƒƒãƒ—ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  popup.classList.remove('shia-show', 'shia-visible');
  void popup.offsetWidth; // reflow
  popup.classList.add('shia-hide');
  popup.addEventListener('animationend', () => {
    popup.classList.remove('shia-hide');
    const ctx = canvas.getContext('2d');
    if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
    canvas.style.opacity = '0';
  }, { once: true });
}

// ===== EXPLOSION =====
let sparkAnimFrame = null;

function spawnSparks() {
  const canvas = document.getElementById('sparks-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const particles = [];
  for (let i = 0; i < 150; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * 22 + 4;
    particles.push({
      x: canvas.width / 2,
      y: canvas.height * 0.4,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 5,
      life: 1,
      size: Math.random() * 10 + 3,
      color: ['#e63946', '#ff7f11', '#ffd60a', '#ffffff', '#06d6a0'][Math.floor(Math.random() * 5)],
    });
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (const p of particles) {
      if (p.life <= 0) continue;
      // æ˜Ÿå‹ã«ã™ã‚‹
      ctx.globalAlpha = Math.max(0, p.life * p.life);
      ctx.fillStyle = p.color;
      ctx.strokeStyle = '#1a1a2e';
      ctx.lineWidth = 1;
      const r = p.size * p.life;
      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.5;
      p.vx *= 0.97;
      p.life -= 0.014;
    }
    ctx.globalAlpha = 1;
    if (particles.some(p => p.life > 0)) {
      sparkAnimFrame = requestAnimationFrame(draw);
    }
  }
  draw();
}

// çˆ†ç™ºæ™‚ã®Shia canvas chroma key
let explosionVideo = null;
let explosionAnimFrame = null;

function initExplosionVideo() {
  explosionVideo = document.createElement('video');
  explosionVideo.src = 'shia_explosion.mp4';
  explosionVideo.preload = 'auto';
  explosionVideo.muted = false; // éŸ³ã‚’æœ‰åŠ¹åŒ–
  explosionVideo.playsInline = true;
  explosionVideo.loop = true;
  explosionVideo.crossOrigin = 'anonymous';
}

function startExplosionVideo() {
  if (!explosionVideo) return;

  const canvas = document.getElementById('shia-canvas-explosion');
  const W = Math.min(window.innerWidth * 0.45, 400);
  canvas.width = W;
  canvas.height = W * 1.5;
  canvas.style.width = W + 'px';
  canvas.style.height = (W * 1.5) + 'px';

  explosionVideo.currentTime = 0;
  explosionVideo.play().catch(() => {
    explosionVideo.muted = true;
    explosionVideo.play().catch(() => {});
  });

  if (explosionAnimFrame) cancelAnimationFrame(explosionAnimFrame);

  function renderFrame() {
    drawChromaKey(explosionVideo, canvas, 45);
    explosionAnimFrame = requestAnimationFrame(renderFrame);
  }

  explosionVideo.addEventListener('play', () => {
    explosionAnimFrame = requestAnimationFrame(renderFrame);
  }, { once: true });

  // videoèª­ã¿è¾¼ã¿æ¸ˆã¿ãªã‚‰ã™ãé–‹å§‹
  if (explosionVideo.readyState >= 2) {
    explosionAnimFrame = requestAnimationFrame(renderFrame);
  }
}

function stopExplosionVideo() {
  if (explosionAnimFrame) {
    cancelAnimationFrame(explosionAnimFrame);
    explosionAnimFrame = null;
  }
  if (explosionVideo) {
    explosionVideo.pause();
  }
  const canvas = document.getElementById('shia-canvas-explosion');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// ===== TRIGGER WORDS =====
const TRIGGER_WORDS = [
  'ã‚ã‚“ã©ã„', 'ã‚ã‚“ã©ãã•ã„', 'ç„¡ç†', 'ã‚„ã‚ŠãŸããªã„', 'ã‚„ã‚‹æ°—ãªã„',
  'ç–²ã‚ŒãŸ', 'ã¤ã‹ã‚ŒãŸ', 'çœ ã„', 'ã­ã‚€ã„', 'ã ã‚‹ã„',
  'ã¾ãŸä»Šåº¦', 'æ˜æ—¥ã§ã„ã„', 'ã‚ã¨ã§', 'å¾Œã§', 'ã„ã¤ã‹ã‚„ã‚‹',
  'è«¦ã‚ãŸ', 'ã‚ãã‚‰ã‚ãŸ', 'è¾ã‚ã‚‹', 'ã‚„ã‚ã‚‹', 'ã§ããªã„',
  'ã©ã†ã›', 'ç„¡é§„', 'ã‚€ã ', 'æ„å‘³ãªã„', 'æ„å‘³ã­ãˆ',
];

function checkTriggerWords(text) {
  return TRIGGER_WORDS.some(w => text.includes(w));
}

const justDoItSpeeches = [
  "è¨€ã„è¨³ã‚’ã‚„ã‚ã‚ï¼ä»Šã™ãã‚„ã‚Œï¼ï¼",
  "å®Œç’§ãªæº–å‚™ãªã©æ°¸é ã«æ¥ãªã„ï¼ï¼ä»Šã“ã®ç¬é–“ãŒãã®æ™‚ã ï¼ï¼",
  "ã§ããªã„ã˜ã‚ƒãªãã¦ã‚„ã‚‰ãªã„ã‚“ã ã‚ï¼ï¼ã•ã£ã•ã¨ã‚„ã‚Œï¼ï¼",
  "ãã‚Œã§æ­»ã¬ã®ã‹ï¼ï¼Ÿé•ã†ã ã‚ï¼ï¼ãªã‚‰ã‚„ã‚Œï¼ï¼",
  "å¤±æ•—ã‚’æã‚Œã‚‹ãªï¼ï¼ã‚„ã‚‰ãªã„å¾Œæ‚”ã®æ–¹ãŒãšã£ã¨é‡ã„ï¼ï¼",
  "ä½•ã‚’å¾…ã£ã¦ã‚‹ï¼ï¼ãƒãƒ£ãƒ³ã‚¹ã¯ãŠå‰ãŒå‹•ã„ãŸæ™‚ã«ç”Ÿã¾ã‚Œã‚‹ã‚“ã ï¼ï¼",
  "ãŠå‰ã«ã¯ã§ãã‚‹ï¼ï¼ã ã‹ã‚‰ã‚„ã‚Œï¼ï¼ä»Šã™ãã‚„ã‚Œï¼ï¼",
];

function triggerExplosion() {
  const speech = justDoItSpeeches[Math.floor(Math.random() * justDoItSpeeches.length)];
  document.getElementById('oji-speech').textContent = speech;
  document.getElementById('explosion').classList.add('active');
  document.body.style.overflow = 'hidden';
  spawnSparks();
  startExplosionVideo();
  document.body.style.animation = 'shake 0.12s infinite';
  setTimeout(() => { document.body.style.animation = ''; }, 800);
}

function dismissExplosion() {
  stopExplosionVideo();
  document.getElementById('explosion').classList.remove('active');
  document.body.style.overflow = '';
  if (sparkAnimFrame) cancelAnimationFrame(sparkAnimFrame);

  const resetInterval = setInterval(() => {
    gaugeValue = Math.max(0, gaugeValue - 5);
    updateGauge(gaugeValue);
    if (gaugeValue <= 0) clearInterval(resetInterval);
  }, 30);

  const dismissPrompts = [
    'â€¦ä»Šåº¦è¨€ã„è¨³ã—ãŸã‚‰ã€ã‚‚ã£ã¨é•·ãæµã™ã‹ã‚‰ãªã€‚',
    'ã‚„ã‚‹ã¨è¨€ã£ãŸã€‚ãã‚Œã ã‘ã ã€‚ã•ã£ã•ã¨å‹•ã‘ã€‚',
    'å‹•ã‘ã€‚ä»Šã™ãã€‚è©±ã¯ãã‚Œã ã‘ã ã€‚',
    'æ¬¡ã¯è¨±ã•ãªã„ã€‚æœ¬å½“ã«ã€‚',
    'â€¦ã‚ã‹ã£ãŸãªã‚‰ã„ã„ã€‚æ‰‹ã‚’å‹•ã‹ã›ã€‚',
  ];
  const chosen = dismissPrompts[Math.floor(Math.random() * dismissPrompts.length)];
  addMessage('oji', chosen, 'warning');

  conversationHistory.push({
    role: 'model',
    parts: [{ text: `{"type":"NEUTRAL","score":0,"reply":"${chosen}"}` }]
  });
}

// ===== MAIN SEND =====
const INPUT_MAX_LEN = 400; // å…¥åŠ›æ–‡å­—æ•°åˆ¶é™
let isProcessing = false;  // äºŒé‡é€ä¿¡é˜²æ­¢ãƒ•ãƒ©ã‚°

function setProcessing(flag) {
  isProcessing = flag;
  const btn = document.getElementById('send-btn');
  const input = document.getElementById('user-input');
  if (btn) btn.disabled = flag;
  if (input) input.disabled = flag;
}

/** ã‚¨ãƒ©ãƒ¼æ–‡å­—åˆ—ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã‚«ãƒ†ã‚´ãƒªã‚’åˆ¤å®š */
function classifyError(errMsg) {
  const s = (errMsg || '').toLowerCase();
  if (s.includes('429') || s.includes('quota') || s.includes('resource') ||
      s.includes('rate') || s.includes('exhausted') || s.includes('503')) {
    return 'quota';
  }
  if (s.includes('internal server') || s.includes('å¿œç­”ã®è§£æ') ||
      s.includes('parse') || s.includes('json') || s.includes('500') ||
      s.includes('empty response') || s.includes('failed')) {
    return 'parse'; // ãƒ¢ãƒ‡ãƒ«å¿œç­”å•é¡Œ â†’ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  }
  return 'other';
}

// ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç™ºè¨€
const PARSE_FALLBACK_MESSAGES = [
  'â€¦ã†ã¾ãèãå–ã‚Œãªã‹ã£ãŸã€‚ã‚‚ã†ä¸€åº¦è¨€ã£ã¦ã¿ã‚ã€‚',
  'å°‘ã—æ··ä¹±ã—ãŸã€‚ç¹°ã‚Šè¿”ã—ã¦ãã‚Œã€‚',
  'â€¦ä»Šã¯ã†ã¾ãä¼ã‚ã‚‰ãªã‹ã£ãŸã€‚ã ãŒãŠå‰ã®ã‚„ã‚‹æ°—ã¯ä¼ã‚ã£ã¦ã„ã‚‹ã€‚ã‚‚ã†ä¸€åº¦ã ã€‚',
];

async function handleSend() {
  // äºŒé‡é€ä¿¡ãƒ»å‡¦ç†ä¸­ã¯ç„¡è¦–
  if (isProcessing) return;

  const input = document.getElementById('user-input');
  const rawText = input.value;
  const text = rawText.trim();

  // ç©ºæ–‡å­—ãƒã‚§ãƒƒã‚¯
  if (!text) {
    input.value = '';
    return;
  }

  // æ–‡å­—æ•°åˆ¶é™ï¼ˆãƒ¢ãƒ³ã‚­ãƒ¼ãƒ†ã‚¹ãƒˆå¯¾ç­–ï¼‰
  const displayText = text.length > INPUT_MAX_LEN
    ? text.slice(0, INPUT_MAX_LEN) + 'â€¦'
    : text;

  setProcessing(true);
  addMessage('user', displayText);
  input.value = '';

  // ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼šå³åº§ã«ã‚²ãƒ¼ã‚¸100%â†’çˆ†ç™º
  if (checkTriggerWords(text)) {
    const triggerDelta = 100 - gaugeValue;
    updateGauge(100);
    showGaugePopup(triggerDelta, 'EXCUSE');
    addMessage('oji', 'â€¦ãã®ä¸€è¨€ã¯èãé£½ããŸã€‚', 'warning');
    setTimeout(() => {
      triggerExplosion();
      setProcessing(false);
    }, 600);
    return;
  }

  addThinking();

  try {
    const contextualMessage = `[ç¾åœ¨ã®ã‚²ãƒ¼ã‚¸: ${Math.round(gaugeValue)}%]\n${displayText}`;
    const result = await callGeminiWithContext(displayText, contextualMessage);

    removeThinking();

    if (result.type === 'EXCUSE') {
      const delta = Math.abs(result.score || 20);
      updateGauge(gaugeValue + delta);
      showGaugePopup(delta, 'EXCUSE');
      showCommentVideo(); // EXCUSEã®ã¨ãShiaãŒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
    } else if (result.type === 'ACTION') {
      const delta = Math.abs(result.score || 25);
      updateGauge(gaugeValue - delta);
      showGaugePopup(delta, 'ACTION');
    }

    if (gaugeValue >= EXPLOSION_THRESHOLD) {
      addMessage('oji', 'â€¦ã‚‚ã†é™ç•Œã§ã™ã€‚', 'warning');
      setTimeout(() => {
        triggerExplosion();
        setProcessing(false);
      }, 800);
    } else {
      let styleClass = '';
      if (gaugeValue >= 70 && result.type === 'EXCUSE') styleClass = 'warning';
      addMessage('oji', result.reply, styleClass);
      setProcessing(false);
    }
  } catch (err) {
    removeThinking();

    const category = classifyError(err.message);
    if (category === 'quota') {
      const msg = QUOTA_MESSAGES[Math.floor(Math.random() * QUOTA_MESSAGES.length)];
      addMessage('oji', msg, 'quota');
    } else if (category === 'parse') {
      // ãƒ¢ãƒ‡ãƒ«å¿œç­”è§£æå¤±æ•— â†’ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‰ã—ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼æ–‡å­—ã‚’è¦‹ã›ãªã„ï¼‰
      const msg = PARSE_FALLBACK_MESSAGES[Math.floor(Math.random() * PARSE_FALLBACK_MESSAGES.length)];
      addMessage('oji', msg, 'quota');
    } else {
      addMessage('oji', `âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚`, 'warning');
    }
    setProcessing(false);
  }
}

async function callGeminiWithContext(displayText, contextText) {
  conversationHistory.push({
    role: 'user',
    parts: [{ text: contextText }]
  });

  const res = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
      contents: conversationHistory,
    }),
  });

  if (!res.ok) {
    conversationHistory.pop();
    // ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼JSONã‚’è¿”ã™å ´åˆã¨ãã†ã§ãªã„å ´åˆã«å¯¾å¿œ
    let errMsg = `HTTP ${res.status}`;
    try {
      const errData = await res.json();
      errMsg = errData.error || errMsg;
    } catch (_) {}
    throw new Error(errMsg);
  }

  const parsed = await res.json();

  if (!parsed.reply) {
    conversationHistory.pop();
    throw new Error('ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰æœ‰åŠ¹ãªè¿”ç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
  }

  conversationHistory.push({
    role: 'model',
    parts: [{ text: parsed.rawText || JSON.stringify(parsed) }]
  });

  return parsed;
}

// ===== GAUGE POPUP =====
const EXCUSE_PHRASES = [
  'JUST DO IT!!', "DON'T LET YOUR\nDREAMS BE DREAMS!", 'YESTERDAY YOU\nSAID TOMORROW.',
  'NOTHING IS IMPOSSIBLE!', 'MAKE YOUR\nDREAMS COME TRUE!',
];
const ACTION_PHRASES = [
  'YES!! GO GO GO!!', "THAT'S IT!!", 'KEEP GOING!!', 'YOU DID IT!!', 'AMAZING!!',
];

function showGaugePopup(delta, type) {
  if (delta === 0) return;

  document.querySelectorAll('.gauge-popup').forEach(el => el.remove());

  const popup = document.createElement('div');
  popup.className = `gauge-popup ${type === 'EXCUSE' ? 'excuse' : type === 'ACTION' ? 'action' : ''}`;

  const pctEl = document.createElement('div');
  pctEl.className = 'popup-pct';
  const sign = type === 'ACTION' ? 'âˆ’' : '+';
  pctEl.textContent = `${sign}${delta}%`;
  popup.appendChild(pctEl);

  if (type === 'EXCUSE' || type === 'ACTION') {
    const phrases = type === 'EXCUSE' ? EXCUSE_PHRASES : ACTION_PHRASES;
    const phraseEl = document.createElement('div');
    phraseEl.className = 'popup-phrase';
    phraseEl.textContent = phrases[Math.floor(Math.random() * phrases.length)];
    popup.appendChild(phraseEl);
  }

  document.body.appendChild(popup);
  popup.addEventListener('animationend', () => popup.remove());
}

// ===== INIT =====
function initChat() {
  conversationHistory = [];
  updateGauge(0);
  initCommentVideo();
  initExplosionVideo();
  setTimeout(() => {
    addMessage('oji', 'â€¦æ¥ãŸãªã€‚ã§ã€ä»Šæ—¥ã¯ä½•ã‚’ã‚„ã‚‹ï¼Ÿè¨€ã„è¨³ã¯èã‹ãªã„ã€‚');
    conversationHistory.push({
      role: 'model',
      parts: [{ text: '{"type":"NEUTRAL","score":0,"reply":"â€¦æ¥ãŸãªã€‚ã§ã€ä»Šæ—¥ã¯ä½•ã‚’ã‚„ã‚‹ï¼Ÿè¨€ã„è¨³ã¯èã‹ãªã„ã€‚"}' }]
    });
  }, 400);
}

window.addEventListener('load', () => {
  initChat();

  const input = document.getElementById('user-input');
  const charCount = document.getElementById('char-count');

  // æ–‡å­—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
  input.addEventListener('input', () => {
    const len = input.value.length;
    charCount.textContent = `${Math.min(len, INPUT_MAX_LEN)}/${INPUT_MAX_LEN}`;
    charCount.classList.toggle('warn', len > INPUT_MAX_LEN * 0.75 && len <= INPUT_MAX_LEN);
    charCount.classList.toggle('danger', len > INPUT_MAX_LEN);
  });

  // Enter é€ä¿¡ï¼ˆå‡¦ç†ä¸­ã¯ç„¡è¦–ï¼‰
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!isProcessing) handleSend();
    }
  });

  // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«å‹•ç”»ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾
  window.addEventListener('pagehide', () => {
    if (commentVideo) commentVideo.src = '';
    if (explosionVideo) explosionVideo.src = '';
  });
});
</script>
<script src="agentation.js"></script>
</body>
</html>
