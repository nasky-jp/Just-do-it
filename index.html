<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JUST DO IT.</title>
  <style>
    :root {
      --gauge-color: #4ade80;
      --gauge-pct: 0%;
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --border: #2a2a4a;
      --text: #e2e8f0;
      --muted: #64748b;
      --accent: #6366f1;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* ======= EXPLOSION OVERLAY ======= */
    #explosion {
      display: none;
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 100;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #explosion.active { display: flex; }

    .shia-face {
      font-size: clamp(80px, 20vw, 160px);
      animation: shake 0.15s infinite;
      filter: drop-shadow(0 0 40px #ff4400);
      margin-bottom: 16px;
    }

    .just-do-it-text {
      font-size: clamp(36px, 10vw, 96px);
      font-weight: 900;
      letter-spacing: 4px;
      color: #fff;
      text-shadow:
        0 0 20px #ff4400,
        0 0 60px #ff8800,
        0 0 100px #ffaa00;
      animation: pulse-text 0.3s infinite alternate;
      text-align: center;
      line-height: 1.1;
    }

    .oji-speech {
      font-size: clamp(16px, 4vw, 28px);
      color: #ffdd44;
      margin-top: 24px;
      text-align: center;
      padding: 0 24px;
      animation: fade-bounce 0.5s ease;
      font-weight: bold;
      text-shadow: 0 0 10px #ff8800;
    }

    .sparks {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    #dismiss-btn {
      margin-top: 40px;
      padding: 14px 48px;
      background: transparent;
      border: 2px solid #ff4400;
      color: #ff4400;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      letter-spacing: 2px;
      transition: all 0.2s;
    }
    #dismiss-btn:hover {
      background: #ff4400;
      color: #fff;
      box-shadow: 0 0 30px #ff4400;
    }

    /* ======= MAIN UI ======= */
    .wrapper {
      width: 100%;
      max-width: 680px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      text-align: center;
      padding: 8px 0 4px;
    }
    .header h1 {
      font-size: clamp(24px, 6vw, 36px);
      font-weight: 900;
      letter-spacing: 4px;
      color: #fff;
      text-shadow: 0 0 20px rgba(255,68,0,0.4);
      font-family: 'Arial Black', 'Segoe UI', sans-serif;
    }
    .header .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* ======= API KEY SETUPï¼ˆå‰Šé™¤æ¸ˆã¿ï¼šã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ï¼‰ ======= */

    /* ======= GAUGE ======= */
    .gauge-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
    }
    .gauge-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .gauge-label span {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .gauge-label .pct {
      font-size: 14px;
      font-weight: 700;
      color: var(--gauge-color);
    }

    .gauge-bar {
      width: 100%;
      height: 16px;
      background: #0f0f1a;
      border-radius: 99px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .gauge-fill {
      height: 100%;
      width: var(--gauge-pct);
      min-width: 4px;
      background: linear-gradient(90deg, var(--gauge-color), #facc15);
      border-radius: 99px;
      transition: width 0.4s cubic-bezier(.4,2,.6,1), background 0.3s;
      box-shadow: 0 0 10px var(--gauge-color);
    }

    .gauge-stages {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
    }
    .gauge-stages span {
      font-size: 10px;
      color: var(--muted);
    }

    /* ======= CHAT ======= */
    .chat-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      height: 320px;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }
    .chat-box::-webkit-scrollbar { width: 4px; }
    .chat-box::-webkit-scrollbar-track { background: transparent; }
    .chat-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }

    .msg {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      animation: msg-in 0.25s ease;
    }
    .msg.user { flex-direction: row-reverse; }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
      border: 2px solid var(--border);
    }

    /* Avatar A: ç‚ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‹ãƒªã‚¢ãƒ«ç³»çµµæ–‡å­— */
    .msg.oji .avatar {
      background: radial-gradient(circle at 60% 35%, #ff8800 0%, #c0392b 55%, #1e293b 100%);
      border-color: #ff4400;
      font-size: 20px;
      box-shadow: 0 0 10px rgba(255,68,0,0.5), inset 0 -2px 4px rgba(0,0,0,0.4);
    }

    /* Avatar B: JDIãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ.avatar-alt ã‚¯ãƒ©ã‚¹ã§åˆ‡ã‚Šæ›¿ãˆå¯ï¼‰ */
    .msg.oji .avatar.avatar-alt {
      background: linear-gradient(135deg, #1a0000 0%, #3d0000 100%);
      border-color: #ff4400;
      border-width: 2px;
      font-size: 9px;
      font-weight: 900;
      letter-spacing: 0.5px;
      color: #ff4400;
      text-shadow: 0 0 6px #ff4400;
      box-shadow: 0 0 10px rgba(255,68,0,0.4);
      font-family: 'Arial Black', sans-serif;
    }

    .msg.user .avatar { background: #312e81; }

    .bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.6;
    }
    .msg.oji .bubble {
      background: #1e293b;
      border: 1px solid var(--border);
      border-top-left-radius: 2px;
      color: var(--text);
    }
    .msg.oji .bubble.warning {
      border-color: #f59e0b;
      background: #1c1500;
      color: #fbbf24;
    }
    .msg.user .bubble {
      background: #312e81;
      border: 1px solid #4338ca;
      border-top-right-radius: 2px;
      color: #e0e7ff;
    }

    /* ======= THINKING ======= */
    .thinking-dots span {
      display: inline-block;
      animation: dot-bounce 1s infinite;
      font-size: 20px;
      color: var(--muted);
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot-bounce {
      0%,80%,100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }

    /* ======= INPUT ======= */
    .input-area {
      display: flex;
      gap: 10px;
    }
    .input-area textarea {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      padding: 12px 14px;
      resize: none;
      outline: none;
      font-family: inherit;
      line-height: 1.5;
      height: 56px;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .input-area textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(99,102,241,0.2);
    }
    .input-area textarea::placeholder { color: var(--muted); }

    .send-btn {
      width: 56px;
      height: 56px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .send-btn:hover { background: #4f46e5; }
    .send-btn:active { transform: scale(0.95); }
    .send-btn:disabled { background: var(--border); cursor: not-allowed; }

    /* ======= HINT ======= */
    .hint {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    /* ======= ANIMATIONS ======= */
    @keyframes shake {
      0%,100% { transform: translateX(0) rotate(0deg); }
      25% { transform: translateX(-6px) rotate(-3deg); }
      75% { transform: translateX(6px) rotate(3deg); }
    }
    @keyframes pulse-text {
      from { transform: scale(1); }
      to { transform: scale(1.06); }
    }
    @keyframes fade-bounce {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes msg-in {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes gauge-flash {
      0%,100% { box-shadow: 0 0 10px var(--gauge-color); }
      50% { box-shadow: 0 0 30px var(--gauge-color), 0 0 60px var(--gauge-color); }
    }
  </style>
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>

<!-- ===== EXPLOSION ===== -->
<div id="explosion">
  <canvas id="sparks-canvas" class="sparks"></canvas>
  <div id="yt-container" style="display:none; position:absolute; inset:0; z-index:10; background:#000;">
    <iframe
      id="yt-iframe"
      width="100%" height="100%"
      frameborder="0"
      allow="autoplay; fullscreen"
      allowfullscreen
      style="border:none;"
    ></iframe>
    <button id="dismiss-btn-yt" onclick="dismissExplosion()" style="
      position:absolute; bottom:40px; left:50%; transform:translateX(-50%);
      padding:14px 48px; background:transparent; border:2px solid #ff4400;
      color:#ff4400; font-size:18px; font-weight:bold; border-radius:8px;
      cursor:pointer; letter-spacing:2px; z-index:11;
    ">â€¦ã‚ã‹ã£ãŸã€ã‚„ã‚‹</button>
  </div>
  <div class="shia-face">ğŸ’ª</div>
  <div class="just-do-it-text" id="jdi-text">JUST<br>DO IT!!</div>
  <div class="oji-speech" id="oji-speech"></div>
  <button id="dismiss-btn" onclick="dismissExplosion()">â€¦ã‚ã‹ã£ãŸã€ã‚„ã‚‹</button>
</div>

<!-- ===== MAIN ===== -->
<div class="wrapper">
  <div class="header">
    <h1>JUST DO IT.</h1>
    <p class="subtitle">è¨€ã„è¨³ã—ãŸã‚‰æ€’ã‚‰ã‚Œã‚‹ã‚„ã¤</p>
  </div>

  <div class="gauge-section">
    <div class="gauge-label">
      <span>âš¡ è¨€ã„è¨³ã‚²ãƒ¼ã‚¸</span>
      <span class="pct" id="gauge-pct">0%</span>
    </div>
    <div class="gauge-bar">
      <div class="gauge-fill" id="gauge-fill"></div>
    </div>
    <div class="gauge-stages">
      <span>ğŸ˜Œ å¤§ä¸ˆå¤«</span>
      <span>ğŸ˜ æ€ªã—ã„</span>
      <span>ğŸ˜¤ å±é™º</span>
      <span>ğŸ’¥ é™ç•Œ</span>
    </div>
  </div>

  <div class="chat-box" id="chat-box"></div>

  <div class="input-area">
    <textarea id="user-input" placeholder="ã§ã€ä»Šæ—¥ã¯ä½•ã‚„ã‚‹ã‚“ã ï¼Ÿ" rows="2"></textarea>
    <button class="send-btn" id="send-btn" onclick="handleSend()">â†‘</button>
  </div>

  <p class="hint">Enter ã§é€ä¿¡ / Shift+Enter ã§æ”¹è¡Œ</p>
</div>

<script>
// ===== CONFIG =====
const GAUGE_MAX = 100;
const EXPLOSION_THRESHOLD = 100;

// ===== STATE =====
let gaugeValue = 0;
let conversationHistory = [];

// ===== GEMINI API =====
const SYSTEM_PROMPT = `You are the "JUST DO IT guy" â€” modeled after Shia LaBeouf's famous motivational speech.

Your personality and speech style:
- Intense, passionate, direct. You believe ANYONE can achieve anything if they just DO IT.
- You speak with conviction and urgency. Short punchy sentences. Lots of emphasis.
- Key phrases you use naturally: "JUST DO IT!", "Don't let your dreams be dreams!", "Yesterday you said tomorrow.", "Make your dreams come true!", "Nothing is impossible!", "If you're tired of starting over, stop giving up!"
- When the user makes excuses, you listen... but your patience wears thin. You push back harder as the gauge rises.
- You are NOT mean or cruel â€” you genuinely believe in the user. But you are frustrated by excuses.
- You speak in Japanese to the user (since they write in Japanese), but your energy is Shia LaBeouf.

Gauge stages (current gauge will be provided with each message):
- 0-30%: Warm, encouraging. "I believe in you! Just take the first step!"
- 30-60%: Getting impatient. "Yesterday you said tomorrow... sound familiar?"
- 60-80%: Almost at limit. "HOW BAD DO YOU WANT IT?! Stop making excuses!"
- 70%+ with excuse: DESPERATE. "Please... I'm begging you... JUST DO IT!!"
- On ACTION declaration: Pure joy and celebration. "YES!! THAT'S IT!! GO GO GO!!"

IMPORTANT: Respond to the actual content of what the user says. Reference their specific situation. Make it feel personal, not generic.

Always respond in Japanese. Reply must be natural Japanese while capturing Shia's passionate energy.

å¿…ãšJSONã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„ï¼ˆä»–ã®ãƒ†ã‚­ã‚¹ãƒˆä¸å¯ï¼‰ï¼š
{
  "type": "EXCUSE" | "ACTION" | "NEUTRAL",
  "score": 0-50,
  "reply": "è¿”ç­”ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ—¥æœ¬èªï¼‰"
}

typeã®å®šç¾©ï¼š
- EXCUSE: è¨€ã„è¨³ã€å¾Œã‚å‘ãã€ãƒã‚¤ãƒŠã‚¹ç™ºè¨€ã€ã‚„ã‚‰ãªã„ç†ç”±ã€ãƒã‚¬ãƒ†ã‚£ãƒ–ãªæ„Ÿæƒ…è¡¨ç¾ã€ç–²ã‚ŒãŸãƒ»ã§ããªã„ãƒ»ã‚ã‚“ã©ã„ç­‰
- ACTION: è¡Œå‹•å®£è¨€ã€ã‚„ã‚‹ã¨æ±ºã‚ãŸç™ºè¨€ã€å®Ÿè¡Œãƒ»å®Œäº†å ±å‘Š
- NEUTRAL: ã©ã¡ã‚‰ã§ã‚‚ãªã„æ™®é€šã®ç™ºè¨€

scoreã¯å¿…ãšæ­£ã®æ•´æ•°ï¼ˆ0-50ï¼‰ã€‚EXCUSEãªã‚‰å¢—åŠ é‡ã€ACTIONãªã‚‰æ¸›å°‘é‡ã€NEUTRALãªã‚‰0ã€‚è² ã®å€¤ã¯è¿”ã•ãªã„ã“ã¨ã€‚
replyã¯1ã€œ3æ–‡ã€‚ã‚²ãƒ¼ã‚¸å€¤ã¨ä¼šè©±ã®æ–‡è„ˆã‚’è¸ã¾ãˆãŸè¿”ç­”ã€‚`;


// ===== GAUGE =====
function getGaugeStage() {
  if (gaugeValue < 30) return 0;
  if (gaugeValue < 60) return 1;
  if (gaugeValue < 80) return 2;
  return 3;
}

function updateGauge(value) {
  gaugeValue = Math.min(Math.max(value, 0), GAUGE_MAX);
  const pct = Math.round(gaugeValue);

  const fill = document.getElementById('gauge-fill');
  fill.style.setProperty('--gauge-pct', pct + '%');
  fill.style.minWidth = pct === 0 ? '0' : '4px';
  document.getElementById('gauge-pct').textContent = pct + '%';

  let color;
  if (pct < 40) color = '#4ade80';
  else if (pct < 70) color = '#facc15';
  else if (pct < 90) color = '#f97316';
  else color = '#ef4444';

  document.documentElement.style.setProperty('--gauge-color', color);

  if (pct >= 70) {
    fill.style.animation = 'gauge-flash 0.6s infinite';
  } else {
    fill.style.animation = 'none';
  }
}

// ===== CHAT UI =====
function addMessage(role, text, isWarning = false) {
  const box = document.getElementById('chat-box');
  const div = document.createElement('div');
  div.className = `msg ${role}`;

  const avatar = document.createElement('div');
  // Aæ¡ˆ: ç‚èƒŒæ™¯ï¼‹ãƒªã‚¢ãƒ«ç³»çµµæ–‡å­— / Bæ¡ˆ: .avatar-alt ã§JDIãƒ†ã‚­ã‚¹ãƒˆã«åˆ‡ã‚Šæ›¿ãˆå¯
  avatar.className = 'avatar'; // Bæ¡ˆã‚’è¦‹ãŸã„å ´åˆã¯ 'avatar avatar-alt' ã«å¤‰æ›´
  avatar.textContent = role === 'oji' ? 'ğŸ§”â€â™‚ï¸' : 'ğŸ™‹';

  const bubble = document.createElement('div');
  bubble.className = 'bubble' + (isWarning ? ' warning' : '');

  if (role === 'oji') {
    bubble.textContent = '';
    div.appendChild(avatar);
    div.appendChild(bubble);
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;

    let i = 0;
    const speed = Math.max(15, Math.min(40, 1200 / text.length));
    const timer = setInterval(() => {
      bubble.textContent += text[i];
      i++;
      box.scrollTop = box.scrollHeight;
      if (i >= text.length) clearInterval(timer);
    }, speed);
  } else {
    bubble.textContent = text;
    div.appendChild(avatar);
    div.appendChild(bubble);
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
}

function addThinking() {
  const box = document.getElementById('chat-box');
  const div = document.createElement('div');
  div.className = 'msg oji';
  div.id = 'thinking-msg';

  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = 'ğŸ§”â€â™‚ï¸';

  const bubble = document.createElement('div');
  bubble.className = 'bubble thinking-dots';
  bubble.innerHTML = '<span>â—</span><span>â—</span><span>â—</span>';

  div.appendChild(avatar);
  div.appendChild(bubble);
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function removeThinking() {
  const el = document.getElementById('thinking-msg');
  if (el) el.remove();
}

// ===== EXPLOSION =====
let animFrame;
function spawnSparks() {
  const canvas = document.getElementById('sparks-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const particles = [];
  for (let i = 0; i < 120; i++) {
    particles.push({
      x: canvas.width / 2,
      y: canvas.height / 2,
      vx: (Math.random() - 0.5) * 20,
      vy: (Math.random() - 0.5) * 20,
      life: 1,
      size: Math.random() * 8 + 2,
      color: ['#ff4400','#ff8800','#ffcc00','#ffffff'][Math.floor(Math.random()*4)],
    });
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (const p of particles) {
      const r = p.size * p.life;
      if (r <= 0 || p.life <= 0) continue;
      ctx.globalAlpha = Math.max(0, p.life);
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
      ctx.fill();
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.4;
      p.life -= 0.012;
    }
    ctx.globalAlpha = 1;
    if (particles.some(p => p.life > 0)) {
      animFrame = requestAnimationFrame(draw);
    }
  }
  draw();
}

// ===== TRIGGER WORDS =====
// ã“ã‚Œã‚‰ã®ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã¨å•ç­”ç„¡ç”¨ã§ã‚²ãƒ¼ã‚¸100%â†’çˆ†ç™º
const TRIGGER_WORDS = [
  'ã‚ã‚“ã©ã„', 'ã‚ã‚“ã©ãã•ã„', 'ç„¡ç†', 'ã‚„ã‚ŠãŸããªã„', 'ã‚„ã‚‹æ°—ãªã„',
  'ç–²ã‚ŒãŸ', 'ã¤ã‹ã‚ŒãŸ', 'çœ ã„', 'ã­ã‚€ã„', 'ã ã‚‹ã„',
  'ã¾ãŸä»Šåº¦', 'æ˜æ—¥ã§ã„ã„', 'ã‚ã¨ã§', 'å¾Œã§', 'ã„ã¤ã‹ã‚„ã‚‹',
  'è«¦ã‚ãŸ', 'ã‚ãã‚‰ã‚ãŸ', 'è¾ã‚ã‚‹', 'ã‚„ã‚ã‚‹', 'ã§ããªã„',
  'ã©ã†ã›', 'ç„¡é§„', 'ã‚€ã ', 'æ„å‘³ãªã„', 'æ„å‘³ã­ãˆ',
];

function checkTriggerWords(text) {
  return TRIGGER_WORDS.some(w => text.includes(w));
}

const justDoItSpeeches = [
  "è¨€ã„è¨³ã‚’ã‚„ã‚ã‚ï¼ä»Šã™ãã‚„ã‚Œï¼ï¼",
  "å®Œç’§ãªæº–å‚™ãªã©æ°¸é ã«æ¥ãªã„ï¼ï¼ä»Šã“ã®ç¬é–“ãŒãã®æ™‚ã ï¼ï¼",
  "ã§ããªã„ã˜ã‚ƒãªãã¦ã‚„ã‚‰ãªã„ã‚“ã ã‚ï¼ï¼ã•ã£ã•ã¨ã‚„ã‚Œï¼ï¼",
  "ãã‚Œã§æ­»ã¬ã®ã‹ï¼ï¼Ÿé•ã†ã ã‚ï¼ï¼ãªã‚‰ã‚„ã‚Œï¼ï¼",
  "å¤±æ•—ã‚’æã‚Œã‚‹ãªï¼ï¼ã‚„ã‚‰ãªã„å¾Œæ‚”ã®æ–¹ãŒãšã£ã¨é‡ã„ï¼ï¼",
  "ä½•ã‚’å¾…ã£ã¦ã‚‹ï¼ï¼ãƒãƒ£ãƒ³ã‚¹ã¯ãŠå‰ãŒå‹•ã„ãŸæ™‚ã«ç”Ÿã¾ã‚Œã‚‹ã‚“ã ï¼ï¼",
  "ãŠå‰ã«ã¯ã§ãã‚‹ï¼ï¼ã ã‹ã‚‰ã‚„ã‚Œï¼ï¼ä»Šã™ãã‚„ã‚Œï¼ï¼",
];

function triggerExplosion() {
  const speech = justDoItSpeeches[Math.floor(Math.random() * justDoItSpeeches.length)];
  document.getElementById('oji-speech').textContent = speech;
  document.getElementById('explosion').classList.add('active');
  document.body.style.overflow = 'hidden';
  spawnSparks();
  document.body.style.animation = 'shake 0.1s infinite';
  setTimeout(() => { document.body.style.animation = ''; }, 1000);

  // 1.5ç§’å¾Œã«YouTubeå‹•ç”»ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
  setTimeout(() => {
    const ytContainer = document.getElementById('yt-container');
    const ytIframe = document.getElementById('yt-iframe');
    const baseUrl = 'https://www.youtube.com/embed/ZXsQAXx_ao0?start=0&rel=0&modestbranding=1';

    // éŸ³ã‚ã‚Šã§è©¦ã¿ã‚‹
    ytIframe.src = baseUrl + '&autoplay=1';
    ytContainer.style.display = 'block';

    // iframe loadå¾Œã«YouTube IFrame APIã®postMessageã§å†ç”ŸçŠ¶æ…‹ã‚’ç¢ºèª
    // autoplayãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆï¼ˆ=ãƒŸãƒ¥ãƒ¼ãƒˆãªã—ã§å†ç”Ÿä¸å¯ï¼‰ã¯mute=1ã§å†è©¦è¡Œ
    ytIframe.onload = () => {
      setTimeout(() => {
        // YouTube IFrame API: getPlayerState ã‚’é€ä¿¡
        ytIframe.contentWindow.postMessage(
          JSON.stringify({ event: 'command', func: 'getPlayerState', args: [] }),
          'https://www.youtube.com'
        );
      }, 500);
    };

    // YT IFrame APIã‹ã‚‰ã®è¿”ç­”ã‚’å—ã‘å–ã‚‹
    // state: -1=æœªé–‹å§‹, 1=å†ç”Ÿä¸­, 2=ä¸€æ™‚åœæ­¢, 3=ãƒãƒƒãƒ•ã‚¡ä¸­, 5=åœæ­¢
    const onYtMessage = (e) => {
      if (e.origin !== 'https://www.youtube.com') return;
      try {
        const data = JSON.parse(e.data);
        if (data.event === 'infoDelivery' && data.info && 'playerState' in data.info) {
          const state = data.info.playerState;
          // -1ï¼ˆæœªé–‹å§‹ï¼‰= autoplayãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸ â†’ ãƒŸãƒ¥ãƒ¼ãƒˆã§å†è©¦è¡Œ
          if (state === -1 || state === 2) {
            ytIframe.src = baseUrl + '&autoplay=1&mute=1';
          }
          window.removeEventListener('message', onYtMessage);
        }
      } catch(e) { /* parseå¤±æ•—ã¯ç„¡è¦– */ }
    };
    window.addEventListener('message', onYtMessage);
  }, 1500);
}

function dismissExplosion() {
  // YouTubeåœæ­¢ï¼ˆsrcç©ºã«ã—ã¦å†ç”Ÿã‚’æ­¢ã‚ã‚‹ï¼‰
  const ytIframe = document.getElementById('yt-iframe');
  ytIframe.src = '';
  document.getElementById('yt-container').style.display = 'none';

  document.getElementById('explosion').classList.remove('active');
  document.body.style.overflow = '';
  cancelAnimationFrame(animFrame);

  const resetInterval = setInterval(() => {
    gaugeValue = Math.max(0, gaugeValue - 5);
    updateGauge(gaugeValue);
    if (gaugeValue <= 0) clearInterval(resetInterval);
  }, 30);

  // ã‚²ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆå¾Œã®ä¸€è¨€ï¼ˆåœ§å¼·ã‚ï¼‰
  const dismissPrompts = [
    'â€¦ä»Šåº¦è¨€ã„è¨³ã—ãŸã‚‰ã€ã‚‚ã£ã¨é•·ãæµã™ã‹ã‚‰ãªã€‚',
    'ã‚„ã‚‹ã¨è¨€ã£ãŸã€‚ãã‚Œã ã‘ã ã€‚ã•ã£ã•ã¨å‹•ã‘ã€‚',
    'å‹•ã‘ã€‚ä»Šã™ãã€‚è©±ã¯ãã‚Œã ã‘ã ã€‚',
    'æ¬¡ã¯è¨±ã•ãªã„ã€‚æœ¬å½“ã«ã€‚',
    'â€¦ã‚ã‹ã£ãŸãªã‚‰ã„ã„ã€‚æ‰‹ã‚’å‹•ã‹ã›ã€‚',
  ];
  const chosen = dismissPrompts[Math.floor(Math.random() * dismissPrompts.length)];
  addMessage('oji', chosen);

  // ä¼šè©±å±¥æ­´ã«ã‚‚è¿½åŠ 
  conversationHistory.push({
    role: 'model',
    parts: [{ text: `{"type":"NEUTRAL","score":0,"reply":"${chosen}"}` }]
  });
}

// ===== MAIN SEND =====
async function handleSend() {
  const input = document.getElementById('user-input');
  const text = input.value.trim();
  if (!text) return;

  addMessage('user', text);
  input.value = '';
  document.getElementById('send-btn').disabled = true;

  // ãƒˆãƒªã‚¬ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¤å®šï¼šå³åº§ã«ã‚²ãƒ¼ã‚¸100%â†’çˆ†ç™º
  if (checkTriggerWords(text)) {
    updateGauge(100);
    addMessage('oji', 'â€¦ãã®ä¸€è¨€ã¯èãé£½ããŸã€‚', true);
    setTimeout(() => {
      triggerExplosion();
      document.getElementById('send-btn').disabled = false;
    }, 600);
    return;
  }

  addThinking();

  try {
    // ã‚²ãƒ¼ã‚¸æƒ…å ±ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«æ¸¡ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ä»˜ä¸ï¼‰
    const contextualMessage = `[ç¾åœ¨ã®ã‚²ãƒ¼ã‚¸: ${Math.round(gaugeValue)}%]\n${text}`;

    // ä¼šè©±å±¥æ­´ã«å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¿½åŠ ã™ã‚‹å‰ã«
    // callGeminiã§ã¯ contextualMessage ã‚’é€ã‚‹ãŒã€å±¥æ­´ã«ã¯textã‚’å…¥ã‚Œã‚‹
    // â†’ callGeminiã«æ¸¡ã™å‰ã«å±¥æ­´æ“ä½œã‚’åˆ¶å¾¡ã™ã‚‹
    const result = await callGeminiWithContext(text, contextualMessage);

    removeThinking();

    // ã‚²ãƒ¼ã‚¸æ›´æ–°
    if (result.type === 'EXCUSE') {
      updateGauge(gaugeValue + Math.abs(result.score || 20));
    } else if (result.type === 'ACTION') {
      updateGauge(gaugeValue - Math.abs(result.score || 25));
    }

    if (gaugeValue >= EXPLOSION_THRESHOLD) {
      addMessage('oji', 'â€¦ã‚‚ã†é™ç•Œã§ã™ã€‚', true);
      setTimeout(() => {
        triggerExplosion();
        document.getElementById('send-btn').disabled = false;
      }, 800);
    } else {
      const isWarn = gaugeValue >= 70 && result.type === 'EXCUSE';
      addMessage('oji', result.reply, isWarn);
      document.getElementById('send-btn').disabled = false;
    }
  } catch (err) {
    removeThinking();
    addMessage('oji', `âš ï¸ ã‚¨ãƒ©ãƒ¼: ${err.message}`, true);
    document.getElementById('send-btn').disabled = false;
  }
}

async function callGeminiWithContext(displayText, contextText) {
  // å±¥æ­´ã¯contextTextï¼ˆã‚²ãƒ¼ã‚¸æƒ…å ±ä»˜ãï¼‰ã§é€ã‚‹
  conversationHistory.push({
    role: 'user',
    parts: [{ text: contextText }]
  });

  // APIã‚­ãƒ¼ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆ/api/chatï¼‰ã§ç®¡ç†
  // ã‚µãƒ¼ãƒãƒ¼ãŒ {type, score, reply, rawText} ã‚’ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ã§è¿”ã™
  const res = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
      contents: conversationHistory,
    }),
  });

  if (!res.ok) {
    conversationHistory.pop();
    const err = await res.json();
    throw new Error(err.error || `HTTP ${res.status}`);
  }

  const parsed = await res.json();

  if (!parsed.reply) {
    conversationHistory.pop();
    throw new Error('ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰æœ‰åŠ¹ãªè¿”ç­”ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
  }

  // ãƒ¢ãƒ‡ãƒ«ã®è¿”ç­”ã‚’å±¥æ­´ã«è¿½åŠ 
  conversationHistory.push({
    role: 'model',
    parts: [{ text: parsed.rawText || JSON.stringify(parsed) }]
  });

  return parsed;
}

// ===== INIT =====
function initChat() {
  conversationHistory = [];
  updateGauge(0);
  setTimeout(() => {
    addMessage('oji', 'â€¦æ¥ãŸãªã€‚ã§ã€ä»Šæ—¥ã¯ä½•ã‚’ã‚„ã‚‹ï¼Ÿè¨€ã„è¨³ã¯èã‹ãªã„ã€‚');
    conversationHistory.push({
      role: 'model',
      parts: [{ text: '{"type":"NEUTRAL","score":0,"reply":"â€¦æ¥ãŸãªã€‚ã§ã€ä»Šæ—¥ã¯ä½•ã‚’ã‚„ã‚‹ï¼Ÿè¨€ã„è¨³ã¯èã‹ãªã„ã€‚"}' }]
    });
  }, 400);
}

window.addEventListener('load', () => {
  initChat();
});

// ===== KEYBOARD =====
document.getElementById('user-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    handleSend();
  }
});
</script>
<script src="agentation.js"></script>
</body>
</html>
